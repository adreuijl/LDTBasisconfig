GRAPH config:Theatre {

  config:GetDomainTable a elmo:InformationProduct;
    elmo:resultType elmo-rt:Tuple;
    elmo:backend config:LocalBackend;
    elmo:requiredParameter config:DomainTableParameter;
    elmo:query """
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      PREFIX prov: <http://www.w3.org/ns/prov#>
      PREFIX sh: <http://www.w3.org/ns/shacl#>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
      PREFIX dct: <http://purl.org/dc/terms/>
      PREFIX dcat: <http://www.w3.org/ns/dcat#>
      PREFIX foaf: <http://xmlns.com/foaf/0.1/>
      SELECT ?domaintablename
             ?id
             ?begindate
             ("2999-12-31" as ?enddate)
             ?isnull
             ?property
             (concat("http://rws.services.nl/DomainTableWS/Contracts/2010/10",if(bound(?dtype),if(?dtype=xsd:int,"Integer","String"),""),"Field") as ?datatype)
             ?value
      WHERE {
        GRAPH <http://standaard.aquo.nl/data/domeintabelmetadata> {
          ?domaintable rdfs:label ?domaintablename.
          ?domaintable dcat:landingPage ?domaintablegraph.
        }
        OPTIONAL {
          {
            BIND (false as ?isnull)
            GRAPH ?domaintablegraph {
              ?id foaf:isPrimaryTopicOf/prov:generatedAtTime ?begindate.
              ?id ?prop ?value
            }
            GRAPH <http://standaard.aquo.nl/def/domeintabel> {
              ?meta sh:path ?prop.
              ?meta rdfs:label ?property.
              ?meta sh:order ?nr.
              ?meta sh:datatype ?dtype.
            }
          }
          UNION
          {
            BIND (true as ?isnull)
            GRAPH ?domaintablegraph {
              ?id a ?type
            }
            GRAPH <http://standaard.aquo.nl/def/domeintabel> {
              ?shape sh:targetClass ?type.
              ?shape sh:property ?pshape.
              ?pshape sh:path ?prop.
              ?pshape rdfs:label ?property.
              ?pshape sh:order ?nr.
              ?pshape sh:datatype ?dtype.
            }
            FILTER NOT EXISTS {
              GRAPH ?domaintablegraph {
                ?id ?prop ?value
              }
            }
          }
        }
      }
      ORDER BY ?id ?nr
    """
  .

}
